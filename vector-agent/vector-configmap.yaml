# kubernetes-vector-agent/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: vector-agent-config # –ò–º—è ConfigMap
  namespace: argocd         # –ù–µ–π–º—Å–ø–µ–π—Å, –≥–¥–µ –±—É–¥–µ—Ç —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç Vector
data:
  vector.toml: |
#################################################################################

############ - sources - —Å—Ç–∞—Ä—ã–µ —á–∞—Å—Ç–∏ –∫–æ–¥–∞ - ####################################

  # –ò—Å—Ç–æ—á–Ω–∏–∫: —á—Ç–µ–Ω–∏–µ –ª–æ–≥–æ–≤ –∏–∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –Ω–∞ —Ö–æ—Å—Ç–µ (–µ—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–∏—à–µ—Ç –≤ —Ñ–∞–π–ª)
    #[sources.current_time_logs_file]
    #type = "file"
    #include = ["/var/log/k8s-apps/current-time-app-logs/*.log"]
    #ignore_older = 86400
#################################################################################

############ - sources - –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –ª–æ–≥–æ–≤ - ######################################

    # –ò—Å—Ç–æ—á–Ω–∏–∫: –°–±–æ—Ä –ª–æ–≥–æ–≤ stdout/stderr –¢–û–õ–¨–ö–û –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è current-time-app
    [sources.kubernetes_current_time_app_logs]
    type = "kubernetes_logs"
        # –î–ª—è `kubernetes_logs` –Ω–∞—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –≤–∫–ª—é—á–∏—Ç—å `add_metadata`,
    exclude_paths_glob_patterns = ["/var/log/pods/*/vector/*.log"
        # –í–º–µ—Å—Ç–æ pod_fields –∏—Å–ø–æ–ª—å–∑—É–µ–º extra_field_selector –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –∏–º–µ–Ω–∏ –ø–æ–¥–∞
    extra_field_selector = "metadata.name=current-time-app-0" 

    [sources.kube_logs_argocd]
    type = "kubernetes_logs"
    exclude_paths_glob_patterns = ["/var/log/pods/*/vector/*.log"]
    #extra_field_selector = "metadata.name=argocd"
    pod_labels = { "app.kubernetes.io/part-of" = "argocd" }
 

#################################################################################

############ - transforms - —Ç—Ä–∞–Ω—Ñ—Å–æ—Ä–º–∞—Ü–∏—è –ª–æ–≥–æ–≤ - ###############################

##### –ù–ê–°–¢–†–ê–ò–í–ê–ï–ú–´–ô –§–ò–õ–¨–¢–† –ú–ï–¢–ê–î–ê–ù–ù–´–• KUBERNETES ###
    #
    # –≠—Ç–∞ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è `remap` –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤–∞–º –í–´–ë–ò–†–ê–¢–ï–õ–¨–ù–û —É–¥–∞–ª—è—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏–∑ –ª–æ–≥–æ–≤
    # —Å –ø–æ–º–æ—â—å—é Vector Remap Language (VRL).
    # –î–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É `del(.path.to.field)`.

    [transforms.customize_kube_metadata]
    type = "remap" # <--- –ò–ó–ú–ï–ù–ï–ù–û –ù–ê "remap"
    inputs = ["kubernetes_current_time_app_logs"] # –ë–µ—Ä–µ–º –ª–æ–≥–∏ –æ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–∞ Kubernetes
    source = '''
##### –£–¥–∞–ª—è–µ–º—ã–µ –ø–æ–ª—è (—Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ —Å—Ç—Ä–æ–∫—É, —á—Ç–æ–±—ã —É–¥–∞–ª–∏—Ç—å) ###################
      del(.kubernetes.container_image) # –£–¥–∞–ª—è–µ–º –∏–º—è –æ–±—Ä–∞–∑–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
      del(.kubernetes.pod_node_name)   # –£–¥–∞–ª—è–µ–º –∏–º—è —É–∑–ª–∞ –ø–æ–¥–∞
      del(.kubernetes.pod_owner)       # –£–¥–∞–ª—è–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞ –ø–æ–¥–∞
      del(.kubernetes.pod_labels)      # –£–¥–∞–ª—è–µ–º –º–µ—Ç–∫–∏ –ø–æ–¥–∞
      del(.kubernetes.namespace_labels) # –£–¥–∞–ª—è–µ–º –º–µ—Ç–∫–∏ –Ω–µ–π–º—Å–ø–µ–π—Å–∞
      del(.kubernetes.node_labels)     # –£–¥–∞–ª—è–µ–º –º–µ—Ç–∫–∏ —É–∑–ª–∞

##### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã —Ö–æ—Ç–µ–ª–∏ —É–¥–∞–ª–∏—Ç—å —Ä–∞–Ω–µ–µ ################
      del(.file)                      # –£–¥–∞–ª—è–µ–º –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É –ª–æ–≥–∞
      del(.kubernetes.container_id)   # –£–¥–∞–ª—è–µ–º –¥–ª–∏–Ω–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
      del(.kubernetes.container_image_id) # –£–¥–∞–ª—è–µ–º –¥–ª–∏–Ω–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –æ–±—Ä–∞–∑–∞
      del(.kubernetes.pod_ip)         # –£–¥–∞–ª—è–µ–º IP-–∞–¥—Ä–µ—Å –ø–æ–¥–∞
      del(.kubernetes.pod_ips)        # –£–¥–∞–ª—è–µ–º —Å–ø–∏—Å–æ–∫ IP-–∞–¥—Ä–µ—Å–æ–≤ –ø–æ–¥–∞
      del(.kubernetes.pod_uid)        # –£–¥–∞–ª—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –ø–æ–¥–∞ (UUID)

####### –ü–æ–ª—è, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã —Ö–æ—Ç–µ–ª–∏ –û–°–¢–ê–í–ò–¢–¨, –∑–¥–µ—Å—å –Ω–µ –Ω—É–∂–Ω–æ —É–¥–∞–ª—è—Ç—å ################
      # (—Ç.–µ., –æ–Ω–∏ –Ω–µ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω—ã —Å 'del()')
      # kubernetes.container_name
      # kubernetes.pod_name
      # kubernetes.pod_namespace
    ''' # <--- –°–ö–†–ò–ü–¢ VRL –ó–ê–í–ï–†–®–ê–ï–¢–°–Ø –≠–¢–ò–ú–ò –¢–†–ï–ú–Ø –ö–ê–í–´–ß–ö–ê–ú–ò

##### üëâ –î–û–ë–ê–í–¨ remap –¢–ê–ô–ú–°–¢–ê–ú–ü–ê, –ß–¢–û–ë–´ –ò–°–ö–õ–Æ–ß–ò–¢–¨ "out_of_order":
    # –≠—Ç–æ—Ç remap —É–±–µ–¥–∏—Ç—Å—è, —á—Ç–æ .timestamp ‚Äî –≤—Å–µ–≥–¥–∞ —Ç–µ–∫—É—â–∏–π.
    # –ï—Å–ª–∏ –ª–æ–≥ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ–π –º–µ—Ç–∫–∏ –∏–ª–∏ –æ–Ω–∞ –Ω–µ –º–æ–Ω–æ—Ç–æ–Ω–Ω–∞, Loki –º–æ–∂–µ—Ç –≤—ã–±—Ä–∞—Å—ã–≤–∞—Ç—å –æ—à–∏–±–∫—É.
    # –ü—Ä–∏–º–µ—Ä –Ω–∏–∂–µ: –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–¥–∞—ë–º –≤—Ä–µ–º—è —Å–æ–±—ã—Ç–∏—è –∫–∞–∫ —Ç–µ–∫—É—â–µ–µ (UTC).
    [transforms.force_timestamp]
    type = "remap"
    inputs = ["customize_kube_metadata"]
    source = '''
    .timestamp = now()
    '''


#################################################################################

############ - sink - –æ—Ç–ø—Ä–∞–≤–∫–∞ –ª–æ–≥–æ–≤ - ##########################################

    # Sink: –æ—Ç–ø—Ä–∞–≤–∫–∞ –ª–æ–≥–æ–≤ –≤ Loki
    [sinks.loki-dist_from_ks8_current-time]
    type = "loki"
    inputs = ["force_timestamp"] # <--- –í—Ö–æ–¥ —Ç–µ–ø–µ—Ä—å –æ—Ç –ù–û–í–û–ô —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏!
    endpoint = "http://loki-dist-loki-distributed-distributor.argocd.svc.cluster.local:3100"
    encoding.codec = "json"
    healthcheck.enabled = false
    healthcheck.uri = "http://loki-dist-loki-distributed-distributor.local:3100/ready"

    [sinks.loki-dist_from_ks8_current-time.labels]
    job = "current-time"
    application = "current-time-app"
    instance = "{{ kubernetes.pod_name }}" # <-- –ò–ó–ú–ï–ù–ï–ù–û: –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏–º—è –ø–æ–¥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏

    [sinks.loki-argocd]
    type = "loki"
    inputs = ["kube_logs_argocd"]
    endpoint = "http://loki-dist-loki-distributed-distributor.argocd.svc.cluster.local:3100"
    encoding.codec = "json"
    [sinks.loki-argocd.labels]
    job = "argocd"


    # Sink: –í—ã–≤–æ–¥ –ª–æ–≥–æ–≤ stdout/stderr –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ stdout Vector –∞ –ë–ï–ó –î–û–ë–ê–í–õ–ï–ù–ò–Ø –ú–ï–¢–ê–î–ê–ù–ù–´–•
    [sinks.console_kubernetes_current_time_app_logs]
    type = "console"
    inputs = ["force_timestamp"]
    #inputs = ["kubernetes_current_time_app_logs"]
    #inputs = ["customize_kube_metadata"] # <--- –¢–µ–ø–µ—Ä—å –≤—Ö–æ–¥ –æ—Ç –ù–û–í–û–ô —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏!
    encoding.codec = "json" # –í—ã–≤–æ–¥ –≤ JSON –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —á—Ç–µ–Ω–∏—è
    
#################################################################################

############ - sources - —Å—Ç–∞—Ä—ã–µ —á–∞—Å—Ç–∏ –∫–æ–¥–∞ - ####################################    
    
    # Sink: –≤—ã–≤–æ–¥ –ª–æ–≥–æ–≤ –∏–∑ —Ñ–∞–π–ª–∞ –≤ stdout Vector –∞
    #[sinks.console_from_file]
    #type = "console"
    #inputs = ["current_time_logs_file"]
    #encoding.codec = "json"