#!/bin/bash

echo "Начинаем полную переустановку Argo CD..."

# Переменная для неймспейса
NAMESPACE="argocd"

echo "Шаг 1/2: Удаляем существующий неймспейс '$NAMESPACE' и все его ресурсы..."

# Проверяем, существует ли неймспейс перед попыткой удаления
if kubectl get namespace "$NAMESPACE" &>/dev/null; then
    kubectl delete namespace "$NAMESPACE" --wait=true --timeout=300s || {
        echo "Ошибка: Не удалось удалить неймспейс '$NAMESPACE' или операция удаления заняла слишком много времени."
        echo "Возможно, существуют зависшие ресурсы. Попробуйте удалить их вручную или увеличьте таймаут."
        exit 1
    }
    echo "Неймспейс '$NAMESPACE' успешно удален."
else
    echo "Неймспейс '$NAMESPACE' не найден. Продолжаем установку."
fi

echo ""
echo "Шаг 2/2: Запускаем скрипт чистой установки Argo CD (01-argocd-install.sh)..."

# Проверяем, существует ли установочный скрипт
if [ -f "./01-argocd-install.sh" ]; then
    # Запускаем установочный скрипт
    ./01-argocd-install.sh
    if [ $? -ne 0 ]; then
        echo "Ошибка: Скрипт установки (01-argocd-install.sh) завершился с ошибкой. Переустановка не удалась."
        exit 1
    fi
else
    echo "Ошибка: Установочный скрипт '01-argocd-install.sh' не найден в текущей директории."
    echo "Убедитесь, что скрипт '01-argocd-install.sh' находится рядом с '02-argocd-reinstall.sh'."
    exit 1
fi

echo ""
echo "Полная переустановка Argo CD завершена!"
echo "Проверьте статус подов и получите пароль администратора, используя информацию из предыдущего скрипта."